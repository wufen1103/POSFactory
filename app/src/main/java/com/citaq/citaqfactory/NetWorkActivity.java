package com.citaq.citaqfactory;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileReader;
import java.io.IOException;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.net.NetworkInterface;
import java.util.Collections;
import java.util.List;
import java.util.Locale;
import java.util.Timer;
import java.util.TimerTask;

import com.citaq.util.PingLooperThread;
import com.citaq.util.PingLooperThread.Callbak;
import com.citaq.util.WifiAdmin;

import android.annotation.SuppressLint;
import android.app.Activity;
import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.content.IntentFilter;
import android.content.res.Resources;
import android.net.ConnectivityManager;
import android.net.NetworkInfo;
import android.net.Uri;
import android.net.wifi.WifiInfo;
import android.net.wifi.WifiManager;
import android.os.Build;
import android.os.Bundle;
import android.os.Handler;
import android.os.Message;
import android.provider.Settings;
import android.telephony.PhoneStateListener;
import android.telephony.SignalStrength;
import android.telephony.TelephonyManager;
import android.text.TextUtils;
import android.util.Log;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.AdapterView;
import android.widget.AdapterView.OnItemSelectedListener;
import android.widget.CompoundButton.OnCheckedChangeListener;
import android.widget.ArrayAdapter;
import android.widget.Button;
import android.widget.CompoundButton;
import android.widget.EditText;
import android.widget.ProgressBar;
import android.widget.Spinner;
import android.widget.TextView;
import android.widget.Toast;
import android.widget.ToggleButton;

/*源代码路径/media/resource/android/sourcecode/jellybean/frameworks/base/wifi/java/android/net/wifi/wifimanager.java
		源码中这样描述的*/
/** Anything worse than or equal to this will show 0 bars.
private static final int MIN_RSSI = -100;

*//** Anything better than or equal to this will show the max bars. *//*
private static final int MAX_RSSI = -55;

*//**
 * Number of RSSI levels used in the framework to initiate
 * {@link #RSSI_CHANGED_ACTION} broadcast
 * @hide
 *//*
public static final int RSSI_LEVELS = 5;*/
/**
 * Calculates the level of the signal. This should be used any time a signal
 * is being shown.
 *
 * @param rssi The power of the signal measured in RSSI.
 * @param numLevels The number of levels to consider in the calculated
 *            level.
 * @return A level of the signal, given in the range of 0 to numLevels-1
 *         (both inclusive).
 */

/*public static int calculateSignalLevel(int rssi, int numLevels) {
		if (rssi <= MIN_RSSI) {
		return 0;
		} else if (rssi >= MAX_RSSI) {
		return numLevels - 1;
		} else {
		float inputRange = (MAX_RSSI - MIN_RSSI);
		float outputRange = (numLevels - 1);
		return (int)((float)(rssi - MIN_RSSI) * outputRange / inputRange);
		}
		}*/


public class NetWorkActivity extends Activity {
	protected static final String TAG = "NetWorkActivity";

	protected static final int wifi_state = 1001;
	protected static final int ping_state = 1002;

	private int networkType = 0; // NETWORK_TYPE_UNKNOWN
	

	ConnectivityManager connectivityManager;
	private WifiInfo wifiInfo = null; // 获得的Wifi信息
	private WifiManager wifiManager = null; // Wifi管理器

	TelephonyManager telephoneManager;
	int type;

	private int wifi_level;

	TextView tv_info;
	TextView tv_signal_strength;
	TextView tv_signal_strength_3G;
	TextView tv_ping_result;
	TextView tv_success_percentage;
	Button bt_start;
	Button bt_baidu, bt_wifi;
	EditText et_network_addr;
	
	Spinner spinner_time_count;
	private ArrayAdapter<?> adapter_time;
	int pingTime =10;

	Resources mResources;

	boolean isRun = true;
//	int timeOut = 10 * 1000;

	Handler uiHandler;

//	Runnable runnable;

	Timer timer;

	Context mContext;
	
	private ToggleButton tb_wifi;
	
	WifiAdmin wifiAdmin;
	String[] defaultWifiInfo ={ "wifitest", "CitaqServerAp", "3"};
	
	ProgressBar mProgressBar;
	
	PingLooperThread mPingLooperThread;
	
	boolean istesting =false;

	@Override
	protected void onCreate(Bundle savedInstanceState) {
		// TODO Auto-generated method stub
		super.onCreate(savedInstanceState);
		mContext = this;
		setContentView(R.layout.activity_network);

		wifiManager = (WifiManager) this.getApplicationContext().getSystemService(WIFI_SERVICE);
		telephoneManager = (TelephonyManager) getSystemService(Context.TELEPHONY_SERVICE);

		wifiAdmin = new WifiAdmin(mContext);
	

		initView();
	}

	@Override
	protected void onStart() {
		// TODO Auto-generated method stub
		super.onStart();
		IntentFilter mFilter = new IntentFilter();
		mFilter.addAction(ConnectivityManager.CONNECTIVITY_ACTION);
		registerReceiver(myNetReceiver, mFilter);

		telephoneManager.listen(phoneStateListener, PhoneStateListener.LISTEN_SIGNAL_STRENGTHS);
		type = telephoneManager.getNetworkType();
	}

	private void initView() {
		tv_ping_result = (TextView) findViewById(R.id.result);
		tv_success_percentage = (TextView) findViewById(R.id.success_percentage);
		bt_start = (Button) findViewById(R.id.begin);
		bt_baidu = (Button) findViewById(R.id.baidu);
		bt_wifi = (Button) findViewById(R.id.wifi);

		et_network_addr = (EditText) findViewById(R.id.web);
		et_network_addr.setSelection(et_network_addr.getText().length());
		et_network_addr.clearFocus();
		
		tb_wifi = (ToggleButton) findViewById(R.id.tb_wifi);
		mProgressBar = (ProgressBar) findViewById(R.id.myprobar);
		
		
		tv_info = (TextView) findViewById(R.id.tv_show_status);
		tv_signal_strength = (TextView) findViewById(R.id.tv_signal_strength);
		tv_signal_strength_3G = (TextView) findViewById(R.id.tv_signal_strength_3G);
		spinner_time_count = (Spinner) findViewById(R.id.spinner_time_count);
		
		adapter_time= ArrayAdapter.createFromResource(this, R.array.ping_time, android.R.layout.simple_spinner_item);
		adapter_time.setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item);
		spinner_time_count.setAdapter(adapter_time);
		spinner_time_count.setSelection(0);
		spinner_time_count.setOnItemSelectedListener(new OnItemSelectedListener() {

			@Override
			public void onItemSelected(AdapterView<?> arg0, View arg1,
					int arg2, long arg3) {
				switch (arg2) {
				case 0:
					pingTime = 10;
					break;
				case 1:
					pingTime = 12;
					break;
				case 2:
					pingTime = 14;
					break;
				case 3:
					pingTime = 16;
					break;
				}
				
				
			}

			@Override
			public void onNothingSelected(AdapterView<?> arg0) {
				// TODO Auto-generated method stub
				
			}
		});
		
		mResources = mContext.getResources();

		bt_start.setEnabled(false);
		et_network_addr.setEnabled(false);
		tv_signal_strength.setText("");

		uiHandler = new Handler() {

			@Override
			public void handleMessage(Message msg) {

				
				switch (msg.what) {
				case wifi_state:
					if (networkType == ConnectivityManager.TYPE_WIFI) {
						int level = WifiManager.calculateSignalLevel(msg.arg1,5);
						tv_signal_strength.setText(
								          mResources.getString(R.string.network_wifi)+", "
										+ mResources.getString(R.string.network_signal_strength)
										+ ":"
										+ msg.arg1
										+ "dBm"
										+ ", "
										+mResources.getString(R.string.network_signal_strength)
										+ ":"
										+ level
								);
//						if(Integer.valueOf(msg.what)!= -200)
						{
							tb_wifi.setEnabled(true);
				    		mProgressBar.setVisibility(View.INVISIBLE);
//				    		 System.out.println("1111111111111111111111");
						}
					}
					break;
				case ping_state:
					tv_ping_result.setText(mResources
					.getString(R.string.total_times)
					+ ":"
					+ (msg.arg1+msg.arg2)
					+ ";"
					+ mResources.getString(R.string.success_times)
					+ ":"
					+ msg.arg1
					+ ";"
					+ mResources.getString(R.string.fail_times)
					+ ":"
					+ msg.arg2);
					
					if(msg.arg1+msg.arg2 >0){
						tv_success_percentage.setText(mResources
								.getString(R.string.success_rate)
								+ ":"
								+ String.format("%.2f", (double)msg.arg1/(double)( msg.arg1+msg.arg2) * 100) +"%"
								);
					}
					break;

				default:
					break;
				}
				
				
				super.handleMessage(msg);
			}

		};

		bt_start.setOnClickListener(new OnClickListener() {

			@Override
			public void onClick(View arg0) {
				if (bt_start.getTag().toString().equals(
						mResources.getString(R.string.start))) {

//					bt_start.setText(mResources.getString(R.string.stop));
					bt_start.setTag(mResources.getString(R.string.stop));
					bt_start.setBackgroundDrawable(getResources().getDrawable(R.drawable.btn_pingstop_selector));
					et_network_addr.setEnabled(false);
					istesting =true;
					
					//ping
					mPingLooperThread.start();
					
					uiHandler.postDelayed(new Runnable() {  
					    @Override  
					    public void run() {  
					    	Message msg= new Message();
							mPingLooperThread.sendMessage(msg);
					        //要做的事情  
					        uiHandler.postDelayed(this, pingTime * 1000);  
					    }  
					}, 1000);
					//
					

				} else {

					// bt_start.setText(mResources.getString(R.string.start));
					bt_start.setTag(mResources.getString(R.string.start));
					bt_start.setBackgroundDrawable(getResources().getDrawable(
							R.drawable.btn_ping_selector));
					et_network_addr.setEnabled(true);

					// stop ping
					mPingLooperThread.stop();
					istesting =false;
				}

			}
		});
		
		if(wifiManager.isWifiEnabled()){
			
			WifiInfo wifiInfo = wifiManager.getConnectionInfo();
			if(wifiInfo.getSSID().equals("\""+defaultWifiInfo[0]+"\"")){
				tb_wifi.setChecked(true);
			}
		}
		
		
		tb_wifi.setOnCheckedChangeListener(new OnCheckedChangeListener() {

			@Override
			public void onCheckedChanged(CompoundButton arg0, boolean arg1) {
				if(arg1){
					
					bt_start.setTag(mResources.getString(R.string.start));
					bt_start.setBackgroundDrawable(getResources().getDrawable(
							R.drawable.btn_ping_selector));
					et_network_addr.setEnabled(true);
					mPingLooperThread.stop();
					new Thread(){
						public void run(){


							wifiAdmin.openWifi();
							wifiAdmin.addNetwork(wifiAdmin.CreateWifiInfo(defaultWifiInfo[0], defaultWifiInfo[1], Integer.valueOf(defaultWifiInfo[2])));

						}

					}.start();

					  tb_wifi.setEnabled(false);
					  mProgressBar.setVisibility(View.VISIBLE);
					  
					  /*new Handler().postDelayed(new Runnable(){   

						    public void run() {   

						    	if(wifiManager.isWifiEnabled() ){
						    		tb_wifi.setEnabled(true);
						    		mProgressBar.setVisibility(View.INVISIBLE);
						    	}else{
						    		mProgressBar.setVisibility(View.INVISIBLE);
						    		tb_wifi.setChecked(false);
;						    		tb_wifi.setEnabled(true);
						    	}

						    }   

						 }, 20000);*/
					  
				    
				}else{
					tb_wifi.setEnabled(false);
					mProgressBar.setVisibility(View.VISIBLE);
					wifiAdmin.closeWifi();
				}

			}
		});
		
		bt_baidu.setOnClickListener(new OnClickListener() {
			
			@Override
			public void onClick(View v) {
				openBrowser();
				
			}
		});
		
		bt_wifi.setOnClickListener(new OnClickListener() {
			
			@Override
			public void onClick(View v) {
				Intent intent = new Intent(Settings.ACTION_WIFI_SETTINGS);
				startActivity(intent);
				
			}
		});
		
		mPingLooperThread = new PingLooperThread(new Callbak() {

			@Override
			public boolean handleMessage(int allcount, int success, int faild) {

				Log.i(TAG, allcount + "   "+ success + "         "+faild);

				Message msg = new Message();
				msg.what = ping_state;
				msg.arg1 = success;
				msg.arg2 = faild;
				uiHandler.sendMessage(msg);
				
				return false;
			}
		}, pingTime,et_network_addr.getText().toString());
		
	}



	@Override
	protected void onStop() {
		// TODO Auto-generated method stub
		super.onStop();
//		handler.removeCallbacks(runnable);
		if (myNetReceiver != null) {
			unregisterReceiver(myNetReceiver);
		}
	}



	private void networkRssi(int which) {
		bt_start.setEnabled(true);
		switch (which) {
		case ConnectivityManager.TYPE_WIFI:
			// 使用定时器,每隔5秒获得一次信号强度值
			timer = new Timer();
			timer.scheduleAtFixedRate(new TimerTask() {
				@Override
				public void run() {
					wifiInfo = wifiManager.getConnectionInfo();
					// 获得信号强度值
					wifi_level = wifiInfo.getRssi();
					// 根据获得的信号强度发送信息

					Message msg = new Message();
					msg.what = wifi_state;
					msg.arg1 = wifi_level;
					uiHandler.sendMessage(msg);

				}

			}, 1000, 5000);

			break;
		case ConnectivityManager.TYPE_MOBILE:
			tv_signal_strength.setText("");
			break;
		case ConnectivityManager.TYPE_ETHERNET:
			tv_signal_strength.setText("");
			break;

		default:
			break;
		}
	}

	private BroadcastReceiver myNetReceiver = new BroadcastReceiver() {

		@Override
		public void onReceive(Context context, Intent intent) {

			String action = intent.getAction();
			if (action.equals(ConnectivityManager.CONNECTIVITY_ACTION)) {

				connectivityManager = (ConnectivityManager) getSystemService(Context.CONNECTIVITY_SERVICE);
				NetworkInfo netInfo = connectivityManager.getActiveNetworkInfo();
				if (netInfo != null && netInfo.isAvailable()) {

					// ///////////网络连接
					// String name = netInfo.getTypeName();
					networkType = netInfo.getType();

					if (netInfo.getType() == ConnectivityManager.TYPE_WIFI) {
						// ///WiFi网络
						networkRssi(ConnectivityManager.TYPE_WIFI);
//						tv_info.setText(netInfo.toString());
						tv_info.setText(mResources.getString(R.string.network_type)+":"+mResources.getString(R.string.network_wifi));
							
						
						/*et_network_addr.setEnabled(true);
						bt_start.setEnabled(true);
						
						
						String mac = "";
						if (Build.VERSION.SDK_INT < 23) {
							WifiManager wifi = (WifiManager) context.getApplicationContext().getSystemService(Context.WIFI_SERVICE);
						    if (wifi == null) {
						        return ;
						    }
						    WifiInfo info = null;
						    try {
						        info = wifi.getConnectionInfo();
						    } catch (Exception e) {
						    }
						    if (info == null) {
						        return ;
						    }
						    mac = info.getMacAddress();
						    if (!TextUtils.isEmpty(mac)) {
						        mac = mac.toUpperCase(Locale.ENGLISH);
						    }
						    
					    } else if (Build.VERSION.SDK_INT >= 23 && Build.VERSION.SDK_INT < 24) {
					    	
					        try {
					            mac = new BufferedReader(new FileReader(new File("/sys/class/net/wlan0/address"))).readLine();
					        } catch (IOException e) {
					            e.printStackTrace();
					        }

					    } else if (Build.VERSION.SDK_INT > 24) {
					        mac = getMacFromHardware();
					    }
						
						
						
						tv_info.setText(mResources.getString(R.string.network_type)+":"+mResources.getString(R.string.network_wifi)
								+"   MAC:"+ mac
								);*/
						
					} else if (netInfo.getType() == ConnectivityManager.TYPE_ETHERNET) {
						// ///有线网络
						networkRssi(ConnectivityManager.TYPE_ETHERNET);
//						tv_info.setText(netInfo.toString());
						tv_info.setText(mResources.getString(R.string.network_type)+":"+mResources.getString(R.string.network_ethernet));
						/*tv_info.setText(mResources.getString(R.string.network_type)+":"+mResources.getString(R.string.network_ethernet)
								+"   MAC:"+netInfo.getExtraInfo()	
								);*/
						et_network_addr.setEnabled(true);
						bt_start.setEnabled(true);
						
					} else if (netInfo.getType() == ConnectivityManager.TYPE_MOBILE) {
						// ///////3g网络
						networkRssi(ConnectivityManager.TYPE_MOBILE);
//						tv_info.setText(netInfo.toString());
						tv_info.setText(mResources.getString(R.string.network_type)+":"+mResources.getString(R.string.network_mobile));
						et_network_addr.setEnabled(true);
						bt_start.setEnabled(true);
					}
				} else {
					if(istesting) return;
					// //////网络断开
					tv_info.setText(mResources
							.getString(R.string.network_not_connect));
//					bt_start.setText(mResources.getString(R.string.start));
					bt_start.setTag(mResources.getString(R.string.start));
					bt_start.setBackgroundDrawable(getResources().getDrawable(R.drawable.btn_ping_selector));
					bt_start.setEnabled(false);
					et_network_addr.setEnabled(false);
					tv_signal_strength.setText("");
					
					
					System.out.println("2222222222222222222222");
					tb_wifi.setChecked(false);
					tb_wifi.setEnabled(true);
					mProgressBar.setVisibility(View.INVISIBLE);
					
				}
			}

		}
	};
	
	@SuppressLint("NewApi")
	private static String getMacFromHardware() {
	    try {
	        List<NetworkInterface> all = Collections.list(NetworkInterface.getNetworkInterfaces());
	        for (NetworkInterface nif : all) {
	            if (!nif.getName().equalsIgnoreCase("wlan0")) continue;

	            byte[] macBytes = nif.getHardwareAddress();
	            if (macBytes == null) {
	                return "";
	            }

	            StringBuilder res1 = new StringBuilder();
	            for (byte b : macBytes) {
	                res1.append(String.format("%02X:", b));
	            }

	            if (res1.length() > 0) {
	                res1.deleteCharAt(res1.length() - 1);
	            }
	            return res1.toString();
	        }
	    } catch (Exception e) {
	        e.printStackTrace();
	    }
	    return "02:00:00:00:00:00";
	}

	/*
	　　signalStrength.isGsm() 是否GSM信号 2G or 3G
	　　signalStrength.getCdmaDbm(); 联通3G 信号强度
	　　signalStrength.getCdmaEcio(); 联通3G 载干比
	　　signalStrength.getEvdoDbm(); 电信3G 信号强度
	　　signalStrength.getEvdoEcio(); 电信3G 载干比
	　　signalStrength.getEvdoSnr(); 电信3G 信噪比
	　　signalStrength.getGsmSignalStrength(); 2G 信号强度
	　　signalStrength.getGsmBitErrorRate(); 2G 误码率
	　　载干比 ，它是指空中模拟电波中的信号与噪声的比值
	　　*/
	// 3G
	PhoneStateListener phoneStateListener = new PhoneStateListener() {

		@Override
		public void onSignalStrengthsChanged(SignalStrength signalStrength) {
			// TODO Auto-generated method stub
			super.onSignalStrengthsChanged(signalStrength);
			StringBuffer sb = new StringBuffer();
			int asu = signalStrength
					.getGsmSignalStrength();

			String strength = String.valueOf(asu);
			String strengthdmb = String.valueOf(signalStrength.getCdmaDbm());
			if (type == TelephonyManager.NETWORK_TYPE_UMTS
					|| type == TelephonyManager.NETWORK_TYPE_HSDPA
					|| type == TelephonyManager.NETWORK_TYPE_HSPAP)  //3288 TD-SCDMA ？？
			{
				strengthdmb =String.valueOf(-113+(2*asu));
				// 联通3G

				sb.append(mResources.getString(R.string.network_Unicom_3G))
						.append(",").append(mResources.getString(R.string.network_signal_strength))
						.append(":").append(strengthdmb).append("dBm")
						.append("  ").append(strength).append("asu");

				if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.M) {
					int levle = signalStrength.getLevel();
					sb.append(" ,").append(mResources.getString(R.string.network_signal_level)).append(":")
					.append(levle);
				}

				tv_signal_strength_3G.setText(sb);

			} else if (type == TelephonyManager.NETWORK_TYPE_GPRS
					|| type == TelephonyManager.NETWORK_TYPE_EDGE) {
				// 移动或者联通2g
				sb.append(
						mResources
								.getString(R.string.network_ChinaMobile_Unicom_2G))
						.append(",").append(mResources.getString(R.string.network_signal_strength))
						.append(":").append(strengthdmb).append("dBm")
						.append("  ").append(strength).append("asu");
				tv_signal_strength_3G.setText(sb);
			} else if (type == TelephonyManager.NETWORK_TYPE_EVDO_0
					|| type == TelephonyManager.NETWORK_TYPE_EVDO_A) {
				// 电信3g
				strengthdmb = String.valueOf(signalStrength.getEvdoDbm());
				strengthdmb =String.valueOf(-113+(2*asu));
				sb.append(mResources.getString(R.string.network_CMCC_3G))
						.append(",").append(mResources.getString(R.string.network_signal_strength))
						.append(":").append(strengthdmb).append("dBm")
						.append("  ").append(strength).append("asu");
				tv_signal_strength_3G.setText(sb);
			} else if (type == TelephonyManager.NETWORK_TYPE_LTE) {
				// Reflection code starts from here
				try {
					Method[] methods = android.telephony.SignalStrength.class
							.getMethods();
					for (Method mthd : methods) {
						if (mthd.getName().equals("getLteSignalStrength")
								|| mthd.getName().equals("getLteRsrp")
								|| mthd.getName().equals("getLteRsrq")
								|| mthd.getName().equals("getLteRssnr")
								|| mthd.getName().equals("getLteCqi")) {
							Log.i(TAG,"onSignalStrengthsChanged: "
											+ mthd.getName() + " "
											+ mthd.invoke(signalStrength));
							
							
							if(mthd.getName().equals("getLteRsrp")){
								int strengthdmb_int = (Integer) mthd.invoke(signalStrength);
								strengthdmb = String.valueOf(mthd.invoke(signalStrength));
								sb.append(mResources.getString(R.string.network_lte))
								.append(",")
								.append(mResources
										.getString(R.string.network_signal_strength))
								.append(":").append(strengthdmb).append("dBm")
								.append("  ").append(strengthdmb_int+140).append("asu");

								if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.M) {
									int levle = signalStrength.getLevel();
									sb.append(" ,").append(mResources.getString(R.string.network_signal_level)).append(":")
											.append(levle);
								}
								tv_signal_strength_3G.setText(sb);
								
							}
							//LTE和2G算法不一样，LTE算法是dbm-aus=-140
						}
					}
				} catch (SecurityException e) {
					e.printStackTrace();
				} catch (IllegalArgumentException e) {
					e.printStackTrace();
				} catch (IllegalAccessException e) {
					e.printStackTrace();
				} catch (InvocationTargetException e) {
					e.printStackTrace();
				}
				// Reflection code ends here


			} else {
				sb.append(mResources.getString(R.string.network_Other))
						.append(",").append(mResources.getString(R.string.network_signal_strength))
						.append(":").append(strengthdmb).append("dBm")
						.append("  ").append(strength).append("asu");
//				tv_signal_strength_3G.setText(sb);
			}

		}

	};
	
	private void openBrowser(){
		Intent intent = new Intent();        
		intent.setAction("android.intent.action.VIEW");    
		Uri content_url = Uri.parse("http://www.baidu.com");   
		intent.setData(content_url);           
		intent.setClassName("com.android.browser","com.android.browser.BrowserActivity"); 
		if(getPackageManager().resolveActivity(intent, 0) == null) {
			//com.android.chrome/com.google.android.apps.chrome.Main
			intent.setClassName("com.android.chrome","com.google.android.apps.chrome.Main"); 
			if(getPackageManager().resolveActivity(intent, 0) == null) {
				Toast.makeText(this, "browser is not exit!!!", Toast.LENGTH_SHORT).show();
			}else{
				startActivity(intent);
			}
		}else{
			startActivity(intent);
		}
	}

}
